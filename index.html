<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Late Attendance QR Code Scanner</title>
    <style>
        #scanner {
            width: 100%;
            height: 400px;
            border: 1px solid #000;
        }

        #status {
            font-size: 18px;
            margin-top: 10px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>
    <h1>Scan QR Code for Late Attendance</h1>
    <div id="scanner"></div>
    <h2>Status: <span id="status">Waiting...</span></h2>

    <!-- Include jsQR for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

    <script>
        // Initialize the camera and start scanning
        const videoElement = document.createElement("video");
        const canvasElement = document.createElement("canvas");
        const canvasContext = canvasElement.getContext("2d");

        // Access the camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
                videoElement.srcObject = stream;
                videoElement.setAttribute("autoplay", true);
                videoElement.setAttribute("playsinline", true);
                videoElement.width = 320;
                videoElement.height = 240;
                document.getElementById("scanner").appendChild(videoElement);

                // Continuously scan the video feed
                requestAnimationFrame(scanQRCode);
            })
            .catch(function (err) {
                console.error("Camera error:", err);
                document.getElementById("status").textContent = "Error accessing camera.";
                document.getElementById("status").classList.add("error");
            });

        // Function to scan the QR code from the video stream
        function scanQRCode() {
            if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

                const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    // Display QR Code content
                    const studentId = code.data;
                    document.getElementById("status").textContent = "QR Code Detected!";
                    document.getElementById("status").classList.remove("error");
                    document.getElementById("status").classList.add("success");

                    // Send the student ID to Google Apps Script
                    sendQRCodeData(studentId);
                }
            }

            // Continue scanning
            requestAnimationFrame(scanQRCode);
        }

        // Send QR Code data to Google Apps Script
        function sendQRCodeData(studentId) {
            const url = 'https://script.google.com/macros/s/AKfycbwR0UqeAjYBGjwTkffX-rs5QSC3s1cGfdppC6z6mEBgNgI-yFAhsJ82GQ5nQP5eFyf6/exec'; // Replace with your actual Google Apps Script URL
            const data = new URLSearchParams();
            data.append("studentId", studentId);

            fetch(url, {
                method: 'POST',
                body: data,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById("status").textContent = "Attendance Updated Successfully!";
                        document.getElementById("status").classList.add("success");
                    } else {
                        document.getElementById("status").textContent = "Error: " + data.message;
                        document.getElementById("status").classList.add("error");
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    document.getElementById("status").textContent = "Error updating status";
                    document.getElementById("status").classList.add("error");
                });
        }
    </script>
</body>

</html>
